#!/bin/bash

PHILO=./philo
LOGDIR=logs
VALGRIND_LOG=$LOGDIR/valgrind.log
HELGRIND_LOG=$LOGDIR/helgrind.log

mkdir -p $LOGDIR

echo "========================================"
echo "      PHILOSOPHERS HARDCORE TESTS"
echo "========================================"

run_test () {
	echo
	echo ">>> $1"
	shift
	timeout 5s $PHILO "$@" > /dev/null 2>&1
	RET=$?
	if [ $RET -eq 124 ]; then
		echo "✅ OK (expected infinite simulation)"
	elif [ $RET -eq 0 ]; then
		echo "✅ OK"
	else
		echo "⚠️  EXIT CODE $RET"
	fi
}


echo
echo "===== ARGUMENT VALIDATION ====="
run_test "No args" 
run_test "Too few args" 1 2 3
run_test "Too many args" 1 2 3 4 5 6
run_test "Negative value" -1 800 200 200
run_test "Zero value" 5 0 200 200
run_test "Non-numeric" 5 800 abc 200

echo
echo "===== EDGE CASES ====="
run_test "Single philosopher" 1 800 200 200
run_test "Two philosophers tight" 2 60 30 30

echo
echo "===== DEADLOCK TESTS ====="
run_test "5 philosophers normal" 5 800 200 200
run_test "7 philosophers uneven" 7 300 100 100

echo
echo "===== MUST_EAT TERMINATION ====="
run_test "Must eat small" 5 800 200 200 3
run_test "Must eat large" 100 800 200 200 2

echo
echo "===== STRESS TESTS ====="
run_test "100 philosophers" 100 800 200 200
run_test "200 philosophers" 200 800 200 200

echo
echo "===== TIMING TESTS ====="
run_test "Tight death window" 3 150 100 100
run_test "Ultra tight" 4 60 50 50

echo
echo "===== VALGRIND MEMCHECK ====="
valgrind --leak-check=full --error-exitcode=1 \
	$PHILO 5 800 200 200 2 > $VALGRIND_LOG 2>&1
if [ $? -eq 0 ]; then
	echo "✅ Valgrind (memcheck) clean"
else
	echo "❌ Valgrind (memcheck) FAILED"
	echo "See $VALGRIND_LOG"
fi

echo
echo "===== VALGRIND HELGRIND ====="
valgrind --tool=helgrind --error-exitcode=1 \
	$PHILO 5 800 200 200 > $HELGRIND_LOG 2>&1
if [ $? -eq 0 ]; then
	echo "✅ Helgrind clean (no data races)"
else
	echo "❌ Helgrind FAILED"
	echo "See $HELGRIND_LOG"
fi

echo
echo "========================================"
echo "           TESTS FINISHED"
echo "========================================"
